<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SERVER SURVEY REPORT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
        }
        
        body {
            background-color: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color), #1a2530);
            color: white;
            padding: 20px 0;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: none;
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid #eaeaea;
            font-weight: 600;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0 !important;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-good {
            background-color: rgba(39, 174, 96, 0.15);
            color: var(--success-color);
        }
        
        .status-warning {
            background-color: rgba(243, 156, 18, 0.15);
            color: var(--warning-color);
        }
        
        .status-danger {
            background-color: rgba(231, 76, 60, 0.15);
            color: var(--danger-color);
        }
        
        .progress {
            height: 10px;
            border-radius: 5px;
        }
        
        .server-card {
            border-left: 4px solid var(--secondary-color);
        }
        
        .server-card.issue {
            border-left-color: var(--danger-color);
        }
        
        .server-card.warning {
            border-left-color: var(--warning-color);
        }
        
        .filter-section {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .stats-card {
            text-align: center;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .stats-card:hover {
            transform: scale(1.05);
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .stats-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .nav-tabs .nav-link.active {
            font-weight: 600;
            border-bottom: 3px solid var(--secondary-color);
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 12px;
            color: #6c757d;
        }
        
        .search-box input {
            padding-left: 40px;
        }
        
        .history-table th {
            background-color: var(--light-bg);
            font-weight: 600;
        }
        
        .print-only {
            display: none;
        }
        
        .drive-health-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .drive-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            background-color: white;
        }
        
        .drive-label {
            width: 50px;
            font-weight: 600;
        }
        
        .drive-input {
            flex-grow: 1;
            margin: 0 15px;
        }
        
        .drive-status {
            width: 150px;
            text-align: center;
        }
        
        .issues-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .issue-item {
            padding: 12px 15px;
            border-left: 4px solid var(--danger-color);
            background-color: white;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        
        .issue-item.resolved {
            border-left-color: var(--success-color);
            opacity: 0.7;
        }
        
        .drive-days-input {
            width: 100px;
        }
        
        .failure-date {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 3px;
        }
        
        .resolve-btn {
            font-size: 0.8rem;
            padding: 3px 8px;
        }
        
        .duplicate-warning {
            color: #e74c3c;
            font-size: 0.875rem;
            margin-top: 5px;
            display: none;
        }
        
        .history-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1><i class="fas fa-server me-2"></i>SERVER SURVEY REPORT</h1>
                    <p class="mb-0">Comprehensive server health monitoring and reporting</p>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-light me-2 no-print" id="printReport">
                        <i class="fas fa-print me-1"></i> Print Report
                    </button>
                    <button class="btn btn-light me-2 no-print" id="exportPDF">
                        <i class="fas fa-file-pdf me-1"></i> Export PDF
                    </button>
                    <button class="btn btn-light no-print" id="addServerBtn">
                        <i class="fas fa-plus me-1"></i> Add Server
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Stats Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card" id="totalServersCard">
                    <div class="stats-number text-primary" id="totalServers">0</div>
                    <div class="stats-label">Total Servers</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card" id="healthyServersCard">
                    <div class="stats-number text-success" id="healthyServers">0</div>
                    <div class="stats-label">Healthy Servers</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card" id="warningServersCard">
                    <div class="stats-number text-warning" id="warningServers">0</div>
                    <div class="stats-label">Servers with Warnings</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card" id="criticalServersCard">
                    <div class="stats-number text-danger" id="criticalServers">0</div>
                    <div class="stats-label">Critical Servers</div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="filter-section no-print">
            <div class="row">
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label">Filter by Company</label>
                        <select class="form-select" id="companyFilter">
                            <option value="">All Companies</option>
                            <option value="balmain">Balmain</option>
                            <option value="norich">Norich</option>
                            <option value="nrm">NRM</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label">Filter by Branch</label>
                        <select class="form-select" id="branchFilter">
                            <option value="">All Branches</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label">Filter by Drive Health</label>
                        <select class="form-select" id="driveFilter">
                            <option value="">All Drives</option>
                            <option value="healthy">Healthy</option>
                            <option value="warning">Warning</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label">Filter by Antivirus</label>
                        <select class="form-select" id="antivirusFilter">
                            <option value="">All Status</option>
                            <option value="installed">Installed & Working</option>
                            <option value="not-installed">Not Installed</option>
                            <option value="not-working">Not Working</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-8">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search by server name...">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-grid">
                        <button class="btn btn-outline-secondary" id="resetFilters">
                            <i class="fas fa-redo me-1"></i> Reset Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Server List -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Server Survey Results</span>
                <div>
                    <span class="badge bg-primary me-2" id="filteredCount">0</span>
                    <span>servers</span>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Server Name</th>
                                <th>Company</th>
                                <th>Branch</th>
                                <th>Drive Health</th>
                                <th>UPS Status</th>
                                <th>Antivirus</th>
                                <th>Status</th>
                                <th>Last Updated</th>
                                <th class="no-print">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="serverTableBody">
                            <!-- Server data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Issues Dashboard -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Issues Dashboard</span>
                <div class="form-check form-switch no-print">
                    <input class="form-check-input" type="checkbox" id="showResolvedIssues">
                    <label class="form-check-label" for="showResolvedIssues">Show Resolved</label>
                </div>
            </div>
            <div class="card-body">
                <div class="row" id="issuesDashboard">
                    <!-- Issues will be populated here -->
                </div>
            </div>
        </div>

        <!-- History Records -->
        <div class="card mt-4 no-print">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Survey History</span>
                <div class="history-actions">
                    <span class="badge bg-secondary me-2" id="historyCount">0 records</span>
                    <button class="btn btn-sm btn-outline-danger" id="resetHistoryBtn">
                        <i class="fas fa-trash me-1"></i> Reset History
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Server Name</th>
                                <th>Company</th>
                                <th>Branch</th>
                                <th>Drive Health</th>
                                <th>UPS Status</th>
                                <th>Antivirus</th>
                                <th>Status</th>
                                <th>Comments</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- History data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Server Modal -->
    <div class="modal fade" id="serverModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Add New Server Survey</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="serverForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Company</label>
                                    <select class="form-select" id="company" required>
                                        <option value="">Select Company</option>
                                        <option value="balmain">Balmain</option>
                                        <option value="norich">Norich</option>
                                        <option value="nrm">NRM</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Branch</label>
                                    <select class="form-select" id="branch" required>
                                        <option value="">Select Branch</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Server Name</label>
                            <input type="text" class="form-control" id="serverName" required>
                            <div class="duplicate-warning" id="duplicateWarning">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                This server already exists. Editing will update the existing record.
                            </div>
                        </div>
                        
                        <!-- Drive Health Section -->
                        <div class="drive-health-container">
                            <h6>Drive Health (Days Remaining)</h6>
                            <div class="drive-row">
                                <div class="drive-label">C:</div>
                                <div class="drive-input">
                                    <input type="number" class="form-control drive-days-input" id="driveC" min="0" value="1000">
                                </div>
                                <div class="drive-status">
                                    <span class="status-badge status-good" id="driveCStatus">Healthy</span>
                                    <div class="failure-date" id="driveCFailure"></div>
                                </div>
                            </div>
                            <div class="drive-row">
                                <div class="drive-label">D:</div>
                                <div class="drive-input">
                                    <input type="number" class="form-control drive-days-input" id="driveD" min="0" value="1000">
                                </div>
                                <div class="drive-status">
                                    <span class="status-badge status-good" id="driveDStatus">Healthy</span>
                                    <div class="failure-date" id="driveDFailure"></div>
                                </div>
                            </div>
                            <div class="drive-row">
                                <div class="drive-label">E:</div>
                                <div class="drive-input">
                                    <input type="number" class="form-control drive-days-input" id="driveE" min="0" value="1000">
                                </div>
                                <div class="drive-status">
                                    <span class="status-badge status-good" id="driveEStatus">Healthy</span>
                                    <div class="failure-date" id="driveEFailure"></div>
                                </div>
                            </div>
                            <div class="drive-row">
                                <div class="drive-label">F:</div>
                                <div class="drive-input">
                                    <input type="number" class="form-control drive-days-input" id="driveF" min="0" value="1000">
                                </div>
                                <div class="drive-status">
                                    <span class="status-badge status-good" id="driveFStatus">Healthy</span>
                                    <div class="failure-date" id="driveFFailure"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">UPS Status</label>
                                    <select class="form-select" id="upsStatus" required>
                                        <option value="">Select Status</option>
                                        <option value="working">Working</option>
                                        <option value="not-working">Not Working</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Antivirus Status</label>
                                    <select class="form-select" id="antivirusStatus" required>
                                        <option value="">Select Status</option>
                                        <option value="installed">Installed & Working</option>
                                        <option value="not-installed">Not Installed</option>
                                        <option value="not-working">Not Working</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Comments</label>
                            <textarea class="form-control" id="comments" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveServer">Save Survey</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset History Confirmation Modal -->
    <div class="modal fade" id="resetHistoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Reset History</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to reset the survey history?</p>
                    <div class="alert alert-warning">
                        <strong>Warning:</strong> This action will permanently delete all history records and cannot be undone. 
                        Your current server data will not be affected.
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="confirmReset">
                        <label class="form-check-label" for="confirmReset">
                            I understand this action cannot be undone
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmResetHistory" disabled>
                        <i class="fas fa-trash me-1"></i> Reset History
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Header (only visible when printing) -->
    <div class="print-only">
        <div class="text-center mb-4">
            <h1>SERVER SURVEY REPORT</h1>
            <p>Generated on: <span id="printDate"></span></p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Data structure for companies and branches
        const companies = {
            balmain: ["Chivhu", "Gokwe", "Graniteside", "Gweru", "Kadoma", "Kwekwe"],
            norich: ["Bindura", "Bulawayo", "Chinhoyi", "Karoi", "Marondera", "Rusape"],
            nrm: [
                "Beitbridge", "Bradburn", "Checheche", "Chiredzi CC", "Chiredzi Hardware", 
                "Chiredzi Wholesale", "Chipinge HW", "Chipinge WS", "Chivi", "Hurudza", 
                "Jerera", "Masvingo CC", "Masvingo Hardware", "Masvingo Wholesale", 
                "Mpandawana", "Nyika", "Zvishavane"
            ]
        };

        // Sample data for demonstration
        let servers = JSON.parse(localStorage.getItem('serverSurveyData')) || [
            {
                id: 1,
                serverName: "SRV-BAL-001",
                company: "balmain",
                branch: "Gweru",
                driveHealth: {
                    c: 850,
                    d: 920,
                    e: 750,
                    f: 950
                },
                upsStatus: "working",
                antivirusStatus: "installed",
                comments: "All systems functioning normally.",
                lastUpdated: new Date().toISOString().split('T')[0],
                status: "healthy",
                issues: [],
                resolvedIssues: []
            },
            {
                id: 2,
                serverName: "SRV-NOR-002",
                company: "norich",
                branch: "Bulawayo",
                driveHealth: {
                    c: 450,
                    d: 600,
                    e: 120,
                    f: 800
                },
                upsStatus: "not-working",
                antivirusStatus: "not-working",
                comments: "UPS needs replacement. Antivirus definitions outdated.",
                lastUpdated: new Date().toISOString().split('T')[0],
                status: "critical",
                issues: [
                    { id: 1, type: "ups", description: "UPS not working", resolved: false, dateReported: new Date().toISOString().split('T')[0] },
                    { id: 2, type: "antivirus", description: "Antivirus not working", resolved: false, dateReported: new Date().toISOString().split('T')[0] },
                    { id: 3, type: "drive", description: "Drive E: critical (120 days)", resolved: false, dateReported: new Date().toISOString().split('T')[0] }
                ],
                resolvedIssues: []
            },
            {
                id: 3,
                serverName: "SRV-NRM-003",
                company: "nrm",
                branch: "Masvingo CC",
                driveHealth: {
                    c: 80,
                    d: 400,
                    e: 200,
                    f: 700
                },
                upsStatus: "working",
                antivirusStatus: "not-installed",
                comments: "Drive failure imminent. No antivirus installed.",
                lastUpdated: new Date().toISOString().split('T')[0],
                status: "critical",
                issues: [
                    { id: 1, type: "drive", description: "Drive C: critical (80 days)", resolved: false, dateReported: new Date().toISOString().split('T')[0] },
                    { id: 2, type: "antivirus", description: "Antivirus not installed", resolved: false, dateReported: new Date().toISOString().split('T')[0] }
                ],
                resolvedIssues: []
            }
        ];

        // History records
        let history = JSON.parse(localStorage.getItem('serverSurveyHistory')) || [];

        // DOM elements
        const serverTableBody = document.getElementById('serverTableBody');
        const historyTableBody = document.getElementById('historyTableBody');
        const issuesDashboard = document.getElementById('issuesDashboard');
        const companyFilter = document.getElementById('companyFilter');
        const branchFilter = document.getElementById('branchFilter');
        const driveFilter = document.getElementById('driveFilter');
        const antivirusFilter = document.getElementById('antivirusFilter');
        const searchInput = document.getElementById('searchInput');
        const resetFiltersBtn = document.getElementById('resetFilters');
        const addServerBtn = document.getElementById('addServerBtn');
        const printReportBtn = document.getElementById('printReport');
        const exportPDFBtn = document.getElementById('exportPDF');
        const resetHistoryBtn = document.getElementById('resetHistoryBtn');
        const confirmResetHistory = document.getElementById('confirmResetHistory');
        const confirmResetCheckbox = document.getElementById('confirmReset');
        const historyCount = document.getElementById('historyCount');
        const serverModal = new bootstrap.Modal(document.getElementById('serverModal'));
        const resetHistoryModal = new bootstrap.Modal(document.getElementById('resetHistoryModal'));
        const serverForm = document.getElementById('serverForm');
        const saveServerBtn = document.getElementById('saveServer');
        const companySelect = document.getElementById('company');
        const branchSelect = document.getElementById('branch');
        const serverNameInput = document.getElementById('serverName');
        const duplicateWarning = document.getElementById('duplicateWarning');
        const totalServersEl = document.getElementById('totalServers');
        const healthyServersEl = document.getElementById('healthyServers');
        const warningServersEl = document.getElementById('warningServers');
        const criticalServersEl = document.getElementById('criticalServers');
        const filteredCountEl = document.getElementById('filteredCount');
        const showResolvedIssues = document.getElementById('showResolvedIssues');
        const totalServersCard = document.getElementById('totalServersCard');
        const healthyServersCard = document.getElementById('healthyServersCard');
        const warningServersCard = document.getElementById('warningServersCard');
        const criticalServersCard = document.getElementById('criticalServersCard');

        // Initialize the application
        function init() {
            renderServerTable();
            renderHistoryTable();
            updateDashboardStats();
            updateIssuesDashboard();
            setupEventListeners();
            populateBranchOptions();
            setupDriveInputs();
            setupDuplicateDetection();
            updateHistoryCount();
        }

        // Set up event listeners
        function setupEventListeners() {
            companyFilter.addEventListener('change', filterServers);
            branchFilter.addEventListener('change', filterServers);
            driveFilter.addEventListener('change', filterServers);
            antivirusFilter.addEventListener('change', filterServers);
            searchInput.addEventListener('input', filterServers);
            resetFiltersBtn.addEventListener('click', resetFilters);
            addServerBtn.addEventListener('click', showAddServerModal);
            saveServerBtn.addEventListener('click', saveServer);
            printReportBtn.addEventListener('click', printReport);
            exportPDFBtn.addEventListener('click', exportToPDF);
            resetHistoryBtn.addEventListener('click', showResetHistoryModal);
            confirmResetHistory.addEventListener('click', resetHistory);
            confirmResetCheckbox.addEventListener('change', toggleResetButton);
            companySelect.addEventListener('change', updateBranchOptions);
            showResolvedIssues.addEventListener('change', updateIssuesDashboard);
            
            // Stats card click events for filtering
            totalServersCard.addEventListener('click', () => resetFilters());
            healthyServersCard.addEventListener('click', () => filterByStatus('healthy'));
            warningServersCard.addEventListener('click', () => filterByStatus('warning'));
            criticalServersCard.addEventListener('click', () => filterByStatus('critical'));
        }

        // Show reset history confirmation modal
        function showResetHistoryModal() {
            confirmResetCheckbox.checked = false;
            confirmResetHistory.disabled = true;
            resetHistoryModal.show();
        }

        // Toggle reset button based on confirmation
        function toggleResetButton() {
            confirmResetHistory.disabled = !confirmResetCheckbox.checked;
        }

        // Reset history function
        function resetHistory() {
            // Clear history array
            history = [];
            
            // Update localStorage
            localStorage.setItem('serverSurveyHistory', JSON.stringify(history));
            
            // Update UI
            renderHistoryTable();
            updateHistoryCount();
            
            // Close modal
            resetHistoryModal.hide();
            
            // Show success message
            showAlert('History has been reset successfully.', 'success');
        }

        // Update history count badge
        function updateHistoryCount() {
            historyCount.textContent = `${history.length} records`;
        }

        // Show alert message
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert at the top of the container
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Setup duplicate detection
        function setupDuplicateDetection() {
            serverNameInput.addEventListener('input', checkForDuplicate);
        }

        // Check if server name already exists
        function checkForDuplicate() {
            const serverName = serverNameInput.value.trim();
            if (!serverName) {
                duplicateWarning.style.display = 'none';
                return;
            }

            const existingServer = servers.find(server => 
                server.serverName.toLowerCase() === serverName.toLowerCase()
            );

            if (existingServer) {
                duplicateWarning.style.display = 'block';
                // If we're not already editing this server, set the form to edit mode
                const currentEditId = serverForm.getAttribute('data-edit-id');
                if (!currentEditId || parseInt(currentEditId) !== existingServer.id) {
                    serverForm.setAttribute('data-edit-id', existingServer.id);
                    document.getElementById('modalTitle').textContent = 'Update Server Survey';
                }
            } else {
                duplicateWarning.style.display = 'none';
                serverForm.removeAttribute('data-edit-id');
                document.getElementById('modalTitle').textContent = 'Add New Server Survey';
            }
        }

        // Setup drive inputs
        function setupDriveInputs() {
            const inputs = document.querySelectorAll('.drive-days-input');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    const driveLetter = this.id.replace('drive', '');
                    const statusElement = document.getElementById(`${this.id}Status`);
                    const failureElement = document.getElementById(`${this.id}Failure`);
                    const value = parseInt(this.value) || 0;
                    
                    // Update status based on days remaining
                    const status = getDriveStatus(value);
                    statusElement.textContent = status === 'healthy' ? 'Healthy' : 
                                              status === 'warning' ? 'Warning' : 'Critical';
                    statusElement.className = 'status-badge ' + getDriveStatusClass(value);
                    
                    // Update failure date
                    if (value < 500) {
                        const failureDate = calculateFailureDate(value);
                        failureElement.textContent = `Fail: ${failureDate}`;
                        failureElement.style.display = 'block';
                    } else {
                        failureElement.style.display = 'none';
                    }
                });
            });
        }

        // Calculate failure date based on days remaining
        function calculateFailureDate(days) {
            const today = new Date();
            const failureDate = new Date(today);
            failureDate.setDate(today.getDate() + days);
            return failureDate.toISOString().split('T')[0];
        }

        // Populate branch options based on selected company
        function populateBranchOptions() {
            const company = companySelect.value;
            branchSelect.innerHTML = '<option value="">Select Branch</option>';
            
            if (company && companies[company]) {
                companies[company].forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch;
                    option.textContent = branch;
                    branchSelect.appendChild(option);
                });
            }
        }

        // Update branch options when company changes
        function updateBranchOptions() {
            populateBranchOptions();
            
            // Also update branch filter
            const company = companyFilter.value;
            branchFilter.innerHTML = '<option value="">All Branches</option>';
            
            if (company && companies[company]) {
                companies[company].forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch;
                    option.textContent = branch;
                    branchFilter.appendChild(option);
                });
            }
        }

        // Render server table
        function renderServerTable(serversToRender = servers) {
            serverTableBody.innerHTML = '';
            
            if (serversToRender.length === 0) {
                serverTableBody.innerHTML = '<tr><td colspan="9" class="text-center">No servers found matching your criteria</td></tr>';
                return;
            }
            
            serversToRender.forEach(server => {
                const serverStatus = getServerStatus(server);
                const upsStatusClass = server.upsStatus === 'working' ? 'status-good' : 'status-danger';
                const antivirusStatusClass = getAntivirusStatusClass(server.antivirusStatus);
                const serverStatusClass = getServerStatusClass(serverStatus);
                
                const row = document.createElement('tr');
                row.className = getServerRowClass(server);
                row.innerHTML = `
                    <td>${server.serverName}</td>
                    <td>${formatCompanyName(server.company)}</td>
                    <td>${server.branch}</td>
                    <td>
                        <div class="drive-health-mini">
                            <div class="d-flex mb-1">
                                <small class="me-2">C: ${server.driveHealth.c}d</small>
                                <small class="me-2">D: ${server.driveHealth.d}d</small>
                            </div>
                            <div class="d-flex">
                                <small class="me-2">E: ${server.driveHealth.e}d</small>
                                <small class="me-2">F: ${server.driveHealth.f}d</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="status-badge ${upsStatusClass}">
                            <i class="fas ${server.upsStatus === 'working' ? 'fa-check' : 'fa-times'} me-1"></i>
                            ${server.upsStatus === 'working' ? 'Working' : 'Not Working'}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${antivirusStatusClass}">
                            ${formatAntivirusStatus(server.antivirusStatus)}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${serverStatusClass}">
                            ${serverStatus.charAt(0).toUpperCase() + serverStatus.slice(1)}
                        </span>
                    </td>
                    <td>${server.lastUpdated}</td>
                    <td class="no-print">
                        <button class="btn btn-sm btn-outline-primary edit-server" data-id="${server.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-server" data-id="${server.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                serverTableBody.appendChild(row);
            });
            
            // Add event listeners to edit and delete buttons
            document.querySelectorAll('.edit-server').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const serverId = parseInt(e.currentTarget.getAttribute('data-id'));
                    editServer(serverId);
                });
            });
            
            document.querySelectorAll('.delete-server').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const serverId = parseInt(e.currentTarget.getAttribute('data-id'));
                    deleteServer(serverId);
                });
            });
            
            filteredCountEl.textContent = serversToRender.length;
        }

        // Render history table
        function renderHistoryTable() {
            historyTableBody.innerHTML = '';
            
            if (history.length === 0) {
                historyTableBody.innerHTML = '<tr><td colspan="9" class="text-center">No history records found</td></tr>';
                return;
            }
            
            // Sort history by date (newest first)
            const sortedHistory = [...history].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedHistory.forEach(record => {
                const status = getServerStatus(record);
                const statusClass = getServerStatusClass(status);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.serverName}</td>
                    <td>${formatCompanyName(record.company)}</td>
                    <td>${record.branch}</td>
                    <td>
                        <div class="drive-health-mini">
                            <div class="d-flex mb-1">
                                <small class="me-2">C: ${record.driveHealth.c}d</small>
                                <small class="me-2">D: ${record.driveHealth.d}d</small>
                            </div>
                            <div class="d-flex">
                                <small class="me-2">E: ${record.driveHealth.e}d</small>
                                <small class="me-2">F: ${record.driveHealth.f}d</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="status-badge ${record.upsStatus === 'working' ? 'status-good' : 'status-danger'}">
                            ${record.upsStatus === 'working' ? 'Working' : 'Not Working'}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${getAntivirusStatusClass(record.antivirusStatus)}">
                            ${formatAntivirusStatus(record.antivirusStatus)}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${statusClass}">
                            ${status.charAt(0).toUpperCase() + status.slice(1)}
                        </span>
                    </td>
                    <td>${record.comments || 'No comments'}</td>
                `;
                historyTableBody.appendChild(row);
            });
            
            updateHistoryCount();
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            totalServersEl.textContent = servers.length;
            
            let healthyCount = 0;
            let warningCount = 0;
            let criticalCount = 0;
            
            servers.forEach(server => {
                const status = getServerStatus(server);
                if (status === 'healthy') healthyCount++;
                else if (status === 'warning') warningCount++;
                else if (status === 'critical') criticalCount++;
            });
            
            healthyServersEl.textContent = healthyCount;
            warningServersEl.textContent = warningCount;
            criticalServersEl.textContent = criticalCount;
        }

        // Update issues dashboard
        function updateIssuesDashboard() {
            issuesDashboard.innerHTML = '';
            
            const showResolved = showResolvedIssues.checked;
            let allIssues = [];
            
            servers.forEach(server => {
                // Get current active issues
                const activeIssues = server.issues.filter(issue => !issue.resolved);
                
                // Add server info to each active issue
                activeIssues.forEach(issue => {
                    allIssues.push({
                        server: server.serverName,
                        branch: server.branch,
                        company: server.company,
                        issue: issue.description,
                        date: issue.dateReported,
                        resolved: false,
                        issueId: issue.id,
                        serverId: server.id
                    });
                });
                
                // Add resolved issues if showing them
                if (showResolved) {
                    const resolvedIssues = server.resolvedIssues;
                    resolvedIssues.forEach(issue => {
                        allIssues.push({
                            server: server.serverName,
                            branch: server.branch,
                            company: server.company,
                            issue: issue.description,
                            date: issue.dateReported,
                            resolved: true,
                            resolvedDate: issue.dateResolved,
                            issueId: issue.id,
                            serverId: server.id
                        });
                    });
                }
            });
            
            if (allIssues.length === 0) {
                issuesDashboard.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                        <h4>No Issues Found</h4>
                        <p class="text-muted">All servers are operating within acceptable parameters.</p>
                    </div>
                `;
                return;
            }
            
            // Sort by date (newest first) and then by server name
            allIssues.sort((a, b) => {
                if (a.date !== b.date) {
                    return new Date(b.date) - new Date(a.date);
                }
                return a.server.localeCompare(b.server);
            });
            
            // Create issues list
            const issuesList = document.createElement('div');
            issuesList.className = 'col-12 issues-list';
            
            allIssues.forEach(issue => {
                const issueItem = document.createElement('div');
                issueItem.className = `issue-item ${issue.resolved ? 'resolved' : ''}`;
                issueItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6>${issue.server} <small class="text-muted">- ${issue.branch} (${formatCompanyName(issue.company)})</small></h6>
                            <p class="mb-1">${issue.issue}</p>
                            <small class="text-muted">Reported: ${issue.date}</small>
                            ${issue.resolved ? `<br><small class="text-success">Resolved: ${issue.resolvedDate}</small>` : ''}
                        </div>
                        <div class="d-flex flex-column">
                            ${issue.resolved ? 
                                '<span class="badge bg-success mb-2">Resolved</span>' : 
                                '<span class="badge bg-danger mb-2">Active</span>'
                            }
                            ${!issue.resolved ? 
                                `<button class="btn btn-sm btn-success resolve-btn" data-server-id="${issue.serverId}" data-issue-id="${issue.issueId}">
                                    <i class="fas fa-check me-1"></i> Resolve
                                </button>` : 
                                ''
                            }
                        </div>
                    </div>
                `;
                issuesList.appendChild(issueItem);
            });
            
            issuesDashboard.appendChild(issuesList);
            
            // Add event listeners to resolve buttons
            document.querySelectorAll('.resolve-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const serverId = parseInt(e.currentTarget.getAttribute('data-server-id'));
                    const issueId = parseInt(e.currentTarget.getAttribute('data-issue-id'));
                    resolveIssue(serverId, issueId);
                });
            });
        }

        // Resolve an issue
        function resolveIssue(serverId, issueId) {
            const server = servers.find(s => s.id === serverId);
            if (!server) return;
            
            const issueIndex = server.issues.findIndex(issue => issue.id === issueId);
            if (issueIndex === -1) return;
            
            // Mark issue as resolved
            const resolvedIssue = {
                ...server.issues[issueIndex],
                resolved: true,
                dateResolved: new Date().toISOString().split('T')[0]
            };
            
            // Remove from active issues and add to resolved issues
            server.issues.splice(issueIndex, 1);
            server.resolvedIssues.push(resolvedIssue);
            
            // Update server status
            server.status = getServerStatus(server);
            
            // Add resolution to history
            history.push({
                serverName: server.serverName,
                company: server.company,
                branch: server.branch,
                driveHealth: server.driveHealth,
                upsStatus: server.upsStatus,
                antivirusStatus: server.antivirusStatus,
                comments: `ISSUE RESOLVED: ${resolvedIssue.description}`,
                date: new Date().toISOString().split('T')[0],
                status: server.status,
                action: 'issue_resolved',
                resolvedIssue: resolvedIssue.description
            });
            
            // Save to localStorage
            localStorage.setItem('serverSurveyData', JSON.stringify(servers));
            localStorage.setItem('serverSurveyHistory', JSON.stringify(history));
            
            // Update UI
            updateDashboardStats();
            updateIssuesDashboard();
            renderServerTable();
            renderHistoryTable();
        }

        // Filter servers based on selected criteria
        function filterServers() {
            const company = companyFilter.value;
            const branch = branchFilter.value;
            const driveHealth = driveFilter.value;
            const antivirus = antivirusFilter.value;
            const searchTerm = searchInput.value.toLowerCase();
            
            let filteredServers = servers.filter(server => {
                // Filter by company
                if (company && server.company !== company) return false;
                
                // Filter by branch
                if (branch && server.branch !== branch) return false;
                
                // Filter by drive health
                if (driveHealth) {
                    const status = getServerStatus(server);
                    if (driveHealth !== status) return false;
                }
                
                // Filter by antivirus
                if (antivirus && server.antivirusStatus !== antivirus) return false;
                
                // Filter by search term
                if (searchTerm && !server.serverName.toLowerCase().includes(searchTerm)) return false;
                
                return true;
            });
            
            renderServerTable(filteredServers);
        }

        // Filter by status (used when clicking on stats cards)
        function filterByStatus(status) {
            driveFilter.value = status;
            filterServers();
        }

        // Reset all filters
        function resetFilters() {
            companyFilter.value = '';
            branchFilter.value = '';
            driveFilter.value = '';
            antivirusFilter.value = '';
            searchInput.value = '';
            filterServers();
        }

        // Show add server modal
        function showAddServerModal() {
            document.getElementById('modalTitle').textContent = 'Add New Server Survey';
            serverForm.reset();
            duplicateWarning.style.display = 'none';
            serverForm.removeAttribute('data-edit-id');
            
            // Reset drive inputs to 1000 days
            document.getElementById('driveC').value = 1000;
            document.getElementById('driveD').value = 1000;
            document.getElementById('driveE').value = 1000;
            document.getElementById('driveF').value = 1000;
            
            // Update status displays
            document.getElementById('driveCStatus').textContent = 'Healthy';
            document.getElementById('driveDStatus').textContent = 'Healthy';
            document.getElementById('driveEStatus').textContent = 'Healthy';
            document.getElementById('driveFStatus').textContent = 'Healthy';
            
            document.getElementById('driveCStatus').className = 'status-badge status-good';
            document.getElementById('driveDStatus').className = 'status-badge status-good';
            document.getElementById('driveEStatus').className = 'status-badge status-good';
            document.getElementById('driveFStatus').className = 'status-badge status-good';
            
            // Hide failure dates
            document.getElementById('driveCFailure').style.display = 'none';
            document.getElementById('driveDFailure').style.display = 'none';
            document.getElementById('driveEFailure').style.display = 'none';
            document.getElementById('driveFFailure').style.display = 'none';
            
            serverModal.show();
        }

        // Edit server
        function editServer(id) {
            const server = servers.find(s => s.id === id);
            if (!server) return;
            
            document.getElementById('modalTitle').textContent = 'Update Server Survey';
            document.getElementById('serverName').value = server.serverName;
            document.getElementById('company').value = server.company;
            populateBranchOptions();
            document.getElementById('branch').value = server.branch;
            document.getElementById('upsStatus').value = server.upsStatus;
            document.getElementById('antivirusStatus').value = server.antivirusStatus;
            document.getElementById('comments').value = server.comments;
            
            // Set drive values
            document.getElementById('driveC').value = server.driveHealth.c;
            document.getElementById('driveD').value = server.driveHealth.d;
            document.getElementById('driveE').value = server.driveHealth.e;
            document.getElementById('driveF').value = server.driveHealth.f;
            
            // Update status displays
            document.getElementById('driveCStatus').textContent = getDriveStatus(server.driveHealth.c) === 'healthy' ? 'Healthy' : 
                                                                 getDriveStatus(server.driveHealth.c) === 'warning' ? 'Warning' : 'Critical';
            document.getElementById('driveDStatus').textContent = getDriveStatus(server.driveHealth.d) === 'healthy' ? 'Healthy' : 
                                                                 getDriveStatus(server.driveHealth.d) === 'warning' ? 'Warning' : 'Critical';
            document.getElementById('driveEStatus').textContent = getDriveStatus(server.driveHealth.e) === 'healthy' ? 'Healthy' : 
                                                                 getDriveStatus(server.driveHealth.e) === 'warning' ? 'Warning' : 'Critical';
            document.getElementById('driveFStatus').textContent = getDriveStatus(server.driveHealth.f) === 'healthy' ? 'Healthy' : 
                                                                 getDriveStatus(server.driveHealth.f) === 'warning' ? 'Warning' : 'Critical';
            
            document.getElementById('driveCStatus').className = 'status-badge ' + getDriveStatusClass(server.driveHealth.c);
            document.getElementById('driveDStatus').className = 'status-badge ' + getDriveStatusClass(server.driveHealth.d);
            document.getElementById('driveEStatus').className = 'status-badge ' + getDriveStatusClass(server.driveHealth.e);
            document.getElementById('driveFStatus').className = 'status-badge ' + getDriveStatusClass(server.driveHealth.f);
            
            // Update failure dates
            if (server.driveHealth.c < 500) {
                document.getElementById('driveCFailure').textContent = `Fail: ${calculateFailureDate(server.driveHealth.c)}`;
                document.getElementById('driveCFailure').style.display = 'block';
            }
            if (server.driveHealth.d < 500) {
                document.getElementById('driveDFailure').textContent = `Fail: ${calculateFailureDate(server.driveHealth.d)}`;
                document.getElementById('driveDFailure').style.display = 'block';
            }
            if (server.driveHealth.e < 500) {
                document.getElementById('driveEFailure').textContent = `Fail: ${calculateFailureDate(server.driveHealth.e)}`;
                document.getElementById('driveEFailure').style.display = 'block';
            }
            if (server.driveHealth.f < 500) {
                document.getElementById('driveFFailure').textContent = `Fail: ${calculateFailureDate(server.driveHealth.f)}`;
                document.getElementById('driveFFailure').style.display = 'block';
            }
            
            // Store the ID for updating
            serverForm.setAttribute('data-edit-id', id);
            serverModal.show();
        }

        // Save server (add or update)
        function saveServer() {
            if (!serverForm.checkValidity()) {
                serverForm.reportValidity();
                return;
            }
            
            const serverName = document.getElementById('serverName').value.trim();
            const company = document.getElementById('company').value;
            const branch = document.getElementById('branch').value;
            const driveHealth = {
                c: parseInt(document.getElementById('driveC').value) || 0,
                d: parseInt(document.getElementById('driveD').value) || 0,
                e: parseInt(document.getElementById('driveE').value) || 0,
                f: parseInt(document.getElementById('driveF').value) || 0
            };
            const upsStatus = document.getElementById('upsStatus').value;
            const antivirusStatus = document.getElementById('antivirusStatus').value;
            const comments = document.getElementById('comments').value;
            
            const editId = serverForm.getAttribute('data-edit-id');
            const currentDate = new Date().toISOString().split('T')[0];
            
            // Check for duplicate (case insensitive)
            const existingServer = servers.find(server => 
                server.serverName.toLowerCase() === serverName.toLowerCase() && 
                (!editId || server.id !== parseInt(editId))
            );
            
            if (existingServer && !editId) {
                alert('A server with this name already exists. Please use a different name or edit the existing server.');
                return;
            }
            
            if (editId) {
                // Update existing server
                const index = servers.findIndex(s => s.id === parseInt(editId));
                if (index !== -1) {
                    // Get old server data for comparison
                    const oldServer = servers[index];
                    
                    // Update server
                    servers[index] = {
                        ...servers[index],
                        serverName,
                        company,
                        branch,
                        driveHealth,
                        upsStatus,
                        antivirusStatus,
                        comments,
                        lastUpdated: currentDate
                    };
                    
                    // Update issues based on new status
                    updateServerIssues(servers[index], oldServer);
                    
                    // Add to history
                    history.push({
                        serverName,
                        company,
                        branch,
                        driveHealth,
                        upsStatus,
                        antivirusStatus,
                        comments,
                        date: currentDate,
                        status: getServerStatus(servers[index]),
                        action: 'server_updated'
                    });
                }
            } else {
                // Add new server
                const newId = servers.length > 0 ? Math.max(...servers.map(s => s.id)) + 1 : 1;
                const newServer = {
                    id: newId,
                    serverName,
                    company,
                    branch,
                    driveHealth,
                    upsStatus,
                    antivirusStatus,
                    comments,
                    lastUpdated: currentDate,
                    issues: [],
                    resolvedIssues: []
                };
                
                // Set initial issues
                updateServerIssues(newServer);
                
                servers.push(newServer);
                
                // Add to history
                history.push({
                    serverName,
                    company,
                    branch,
                    driveHealth,
                    upsStatus,
                    antivirusStatus,
                    comments,
                    date: currentDate,
                    status: getServerStatus(newServer),
                    action: 'server_added'
                });
            }
            
            // Save to localStorage
            localStorage.setItem('serverSurveyData', JSON.stringify(servers));
            localStorage.setItem('serverSurveyHistory', JSON.stringify(history));
            
            // Update UI
            renderServerTable();
            renderHistoryTable();
            updateDashboardStats();
            updateIssuesDashboard();
            filterServers();
            
            // Close modal
            serverModal.hide();
            serverForm.removeAttribute('data-edit-id');
        }

        // Update server issues based on current status
        function updateServerIssues(server, oldServer = null) {
            // Clear existing active issues
            server.issues = [];
            
            // Check drives for issues
            Object.entries(server.driveHealth).forEach(([drive, days]) => {
                const status = getDriveStatus(days);
                if (status === 'critical') {
                    server.issues.push({
                        id: Date.now() + Math.random(),
                        type: "drive",
                        description: `Drive ${drive.toUpperCase()}: critical (${days} days)`,
                        resolved: false,
                        dateReported: server.lastUpdated
                    });
                } else if (status === 'warning') {
                    server.issues.push({
                        id: Date.now() + Math.random(),
                        type: "drive",
                        description: `Drive ${drive.toUpperCase()}: warning (${days} days)`,
                        resolved: false,
                        dateReported: server.lastUpdated
                    });
                }
            });
            
            // Check UPS
            if (server.upsStatus === 'not-working') {
                server.issues.push({
                    id: Date.now() + Math.random(),
                    type: "ups",
                    description: "UPS not working",
                    resolved: false,
                    dateReported: server.lastUpdated
                });
            }
            
            // Check antivirus
            if (server.antivirusStatus === 'not-installed') {
                server.issues.push({
                    id: Date.now() + Math.random(),
                    type: "antivirus",
                    description: "Antivirus not installed",
                    resolved: false,
                    dateReported: server.lastUpdated
                });
            } else if (server.antivirusStatus === 'not-working') {
                server.issues.push({
                    id: Date.now() + Math.random(),
                    type: "antivirus",
                    description: "Antivirus not working",
                    resolved: false,
                    dateReported: server.lastUpdated
                });
            }
            
            // Update server status
            server.status = getServerStatus(server);
        }

        // Delete server
        function deleteServer(id) {
            if (confirm('Are you sure you want to delete this server survey?')) {
                const server = servers.find(s => s.id === id);
                if (server) {
                    // Add deletion to history
                    history.push({
                        serverName: server.serverName,
                        company: server.company,
                        branch: server.branch,
                        driveHealth: server.driveHealth,
                        upsStatus: server.upsStatus,
                        antivirusStatus: server.antivirusStatus,
                        comments: 'SERVER DELETED',
                        date: new Date().toISOString().split('T')[0],
                        status: 'deleted',
                        action: 'server_deleted'
                    });
                }
                
                servers = servers.filter(s => s.id !== id);
                
                // Save to localStorage
                localStorage.setItem('serverSurveyData', JSON.stringify(servers));
                localStorage.setItem('serverSurveyHistory', JSON.stringify(history));
                
                // Update UI
                renderServerTable();
                renderHistoryTable();
                updateDashboardStats();
                updateIssuesDashboard();
                filterServers();
            }
        }

        // Print report
        function printReport() {
            document.getElementById('printDate').textContent = new Date().toLocaleDateString();
            
            // Create a print-friendly version
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Server Survey Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .status-good { color: green; }
                        .status-warning { color: orange; }
                        .status-danger { color: red; }
                        .text-center { text-align: center; }
                    </style>
                </head>
                <body>
                    <h1 class="text-center">SERVER SURVEY REPORT</h1>
                    <p class="text-center">Generated on: ${new Date().toLocaleDateString()}</p>
                    
                    <h2>Server Status Summary</h2>
                    <table>
                        <tr>
                            <th>Total Servers</th>
                            <th>Healthy Servers</th>
                            <th>Servers with Warnings</th>
                            <th>Critical Servers</th>
                        </tr>
                        <tr>
                            <td>${servers.length}</td>
                            <td>${servers.filter(s => getServerStatus(s) === 'healthy').length}</td>
                            <td>${servers.filter(s => getServerStatus(s) === 'warning').length}</td>
                            <td>${servers.filter(s => getServerStatus(s) === 'critical').length}</td>
                        </tr>
                    </table>
                    
                    <h2>Server Details</h2>
                    <table>
                        <tr>
                            <th>Server Name</th>
                            <th>Company</th>
                            <th>Branch</th>
                            <th>Drive Health</th>
                            <th>UPS Status</th>
                            <th>Antivirus</th>
                            <th>Status</th>
                            <th>Comments</th>
                        </tr>
            `);
            
            servers.forEach(server => {
                const status = getServerStatus(server);
                const statusClass = status === 'healthy' ? 'status-good' : 
                                  status === 'warning' ? 'status-warning' : 'status-danger';
                
                printWindow.document.write(`
                    <tr>
                        <td>${server.serverName}</td>
                        <td>${formatCompanyName(server.company)}</td>
                        <td>${server.branch}</td>
                        <td>
                            C: ${server.driveHealth.c}d, 
                            D: ${server.driveHealth.d}d, 
                            E: ${server.driveHealth.e}d, 
                            F: ${server.driveHealth.f}d
                        </td>
                        <td>${server.upsStatus === 'working' ? 'Working' : 'Not Working'}</td>
                        <td>${formatAntivirusStatus(server.antivirusStatus)}</td>
                        <td class="${statusClass}">${status.charAt(0).toUpperCase() + status.slice(1)}</td>
                        <td>${server.comments || 'No comments'}</td>
                    </tr>
                `);
            });
            
            printWindow.document.write(`
                    </table>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        // Export to PDF
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(20);
            doc.text('SERVER SURVEY REPORT', 105, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 22, { align: 'center' });
            
            // Add summary table
            doc.autoTable({
                startY: 30,
                head: [['Total Servers', 'Healthy Servers', 'Servers with Warnings', 'Critical Servers']],
                body: [[
                    servers.length,
                    servers.filter(s => getServerStatus(s) === 'healthy').length,
                    servers.filter(s => getServerStatus(s) === 'warning').length,
                    servers.filter(s => getServerStatus(s) === 'critical').length
                ]],
                theme: 'grid',
                headStyles: { fillColor: [44, 62, 80] }
            });
            
            // Prepare data for detailed table
            const tableData = servers.map(server => {
                const status = getServerStatus(server);
                return [
                    server.serverName,
                    formatCompanyName(server.company),
                    server.branch,
                    `C: ${server.driveHealth.c}d, D: ${server.driveHealth.d}d, E: ${server.driveHealth.e}d, F: ${server.driveHealth.f}d`,
                    server.upsStatus === 'working' ? 'Working' : 'Not Working',
                    formatAntivirusStatus(server.antivirusStatus),
                    status.charAt(0).toUpperCase() + status.slice(1),
                    server.comments || 'No comments'
                ];
            });
            
            // Add detailed table
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 10,
                head: [['Server Name', 'Company', 'Branch', 'Drive Health', 'UPS', 'Antivirus', 'Status', 'Comments']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [44, 62, 80] },
                styles: { fontSize: 8 },
                columnStyles: {
                    0: { cellWidth: 25 },
                    1: { cellWidth: 20 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 35 },
                    4: { cellWidth: 15 },
                    5: { cellWidth: 20 },
                    6: { cellWidth: 15 },
                    7: { cellWidth: 'auto' }
                }
            });
            
            // Save the PDF
            doc.save('server-survey-report.pdf');
        }

        // Helper functions
        function getDriveStatusClass(days) {
            if (days >= 500) return 'status-good';
            if (days >= 150) return 'status-warning';
            return 'status-danger';
        }

        function getDriveStatus(days) {
            if (days >= 500) return 'healthy';
            if (days >= 150) return 'warning';
            return 'critical';
        }

        function getServerStatus(server) {
            // Check drive health
            const drives = Object.values(server.driveHealth);
            const criticalDrives = drives.filter(days => getDriveStatus(days) === 'critical').length;
            const warningDrives = drives.filter(days => getDriveStatus(days) === 'warning').length;
            
            // Check other components
            const upsCritical = server.upsStatus === 'not-working';
            const antivirusCritical = server.antivirusStatus === 'not-installed';
            const antivirusWarning = server.antivirusStatus === 'not-working';
            
            // Determine overall status
            if (criticalDrives > 0 || upsCritical || antivirusCritical) {
                return 'critical';
            } else if (warningDrives > 0 || antivirusWarning) {
                return 'warning';
            } else {
                return 'healthy';
            }
        }

        function getServerStatusClass(status) {
            if (status === 'healthy') return 'status-good';
            if (status === 'warning') return 'status-warning';
            return 'status-danger';
        }

        function getAntivirusStatusClass(status) {
            switch(status) {
                case 'installed': return 'status-good';
                case 'not-working': return 'status-warning';
                case 'not-installed': return 'status-danger';
                default: return '';
            }
        }

        function formatAntivirusStatus(status) {
            switch(status) {
                case 'installed': return 'Installed & Working';
                case 'not-working': return 'Not Working';
                case 'not-installed': return 'Not Installed';
                default: return status;
            }
        }

        function formatCompanyName(company) {
            return company.charAt(0).toUpperCase() + company.slice(1);
        }

        function getServerRowClass(server) {
            const status = getServerStatus(server);
            
            if (status === 'critical') {
                return 'table-danger';
            } else if (status === 'warning') {
                return 'table-warning';
            }
            
            return '';
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
